name: Auto YouTube Short

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0,3,7,11,15,18,21 * * *"

concurrency:
  group: auto-youtube-short
  cancel-in-progress: true

jobs:
  make-video:
    runs-on: ubuntu-latest
    timeout-minutes: 35

    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install system & Python deps
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq libsndfile1
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Pick category
        run: |
          CATEGORY=$(shuf -e crime mystery hidden_history | head -n1)
          echo "CATEGORY=$CATEGORY" >> "$GITHUB_ENV"
          echo "Chosen category: $CATEGORY"

      - name: Generate script (DeepSeek via OpenRouter)
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL }}
          CATEGORY: ${{ env.CATEGORY }}
        run: |
          set -euo pipefail
          echo "Running script_generate.py..."
          python script_generate.py
          echo "Script generated successfully."
          head -n 5 script.txt || true

      - name: Generate Narration TTS (XTTS voice clone)
        run: |
          set -euo pipefail
          python tts_generate.py --output tts.wav
          echo "TTS done. File: tts.wav"

      - name: Mix ambience with narration
        run: |
          set -euo pipefail
          # expects audio_mix.py to read tts.wav and your rain/wind/thunder mp3s
          # and output final_audio.wav
          python audio_mix.py tts.wav final_audio.wav
          echo "Audio mix created: final_audio.wav"

      - name: Fetch images (Wikipedia PD + Pexels)
        env:
          PEXELS_KEY: ${{ secrets.PEXELS_KEY }}
        run: |
          set -euo pipefail
          python image_fetch.py
          echo "Images fetched."

      - name: Build Video (Ken Burns Animation + Sync)
        run: |
          set -euo pipefail
          # expects video_build.py to read images + final_audio.wav
          # and output video_raw.mp4
          python video_build.py final_audio.wav
          echo "Video build complete."

      - name: Prevent freeze â€“ trim final video to audio length
        run: |
          set -euo pipefail
          if [ ! -f final_audio.wav ]; then
            echo "final_audio.wav missing"
            exit 1
          fi
          if [ ! -f video_raw.mp4 ]; then
            echo "video_raw.mp4 missing"
            exit 1
          fi
          DURATION=$(ffprobe -v error -show_entries format=duration -of csv=p=0 final_audio.wav)
          ffmpeg -y -i video_raw.mp4 -t "$DURATION" -c:v libx264 -preset veryfast -crf 22 -pix_fmt yuv420p output.mp4
          echo "Final synced video: output.mp4"

      - name: Create Thumbnail
        run: |
          set -euo pipefail
          if [ -f thumbnail.jpg ]; then
            cp thumbnail.jpg final_thumbnail.jpg
            echo "Using custom thumbnail.jpg"
          else
            echo "No custom thumbnail found; grabbing from video."
            ffmpeg -y -i output.mp4 -ss 00:00:01 -vframes 1 final_thumbnail.jpg
          fi

      - name: Save used topic
        run: |
          set -euo pipefail
          if [ -f script_meta.json ]; then
            TITLE=$(jq -r '.title' script_meta.json)
            echo "$TITLE" >> used_topics.txt
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add used_topics.txt
            git commit -m "Used topic: $TITLE" || true
            git push || true
          else
            echo "script_meta.json missing, skipping used_topics update."
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: youtube-short
          path: |
            output.mp4
            final_audio.wav
            script.txt
            script_meta.json
            final_thumbnail.jpg
