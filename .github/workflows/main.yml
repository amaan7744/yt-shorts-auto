name: Auto YouTube Short

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0,2,5,7,10,12,14,17,19,21 * * *"

concurrency:
  group: auto-youtube-short
  cancel-in-progress: true

jobs:
  make-video:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      # ----------------------------------------------------------
      # CHECKOUT + PYTHON + DEPENDENCIES
      # ----------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      # ----------------------------------------------------------
      # PICK CATEGORY (you can change categories later)
      # ----------------------------------------------------------
      - name: Pick category
        run: |
          set -euo pipefail
          CATEGORY=$(shuf -e horror crime mystery | head -n1)
          echo "CATEGORY=$CATEGORY" >> "$GITHUB_ENV"
          echo "Picked category: $CATEGORY"

      # ----------------------------------------------------------
      # GENERATE SCRIPT VIA DEEPSEEK
      # ----------------------------------------------------------
      - name: Generate script (DeepSeek)
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          DEEPSEEK_API_URL: ${{ secrets.DEEPSEEK_API_URL }}
          DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL }}
          CATEGORY: ${{ env.CATEGORY }}
        run: |
          set -euo pipefail
          python script_generate.py
          echo "Script generated:"
          head -n 5 script.txt || true

      # ----------------------------------------------------------
      # TTS VIA E2-F5 / F5-TTS (CLONED VOICE)
      # ----------------------------------------------------------
      - name: Generate narration (E2-F5 / F5-TTS)
        env:
          TTS_SCRIPT_PATH: "script.txt"
          TTS_OUTPUT_PATH: "tts-audio.wav"
        run: |
          set -euo pipefail
          python tts_generate.py --model F5TTS_v1_Base --nfe-step 32 --cfg-strength 2.0 --speed 0.98 --target-rms 0.11

      # ----------------------------------------------------------
      # BUILD VIDEO (IMAGES + AMBIENCE + KEN BURNS)
      # ----------------------------------------------------------
      - name: Build video
        env:
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        run: |
          set -euo pipefail
          python build_video.py

      # ----------------------------------------------------------
      # THUMBNAIL (USE REPO IMAGE OR CREATE SIMPLE ONE)
      # ----------------------------------------------------------
      - name: Thumbnail
        run: |
          python << 'PY'
          import os, shutil, subprocess

          dest = "thumbnail.jpg"

          preferred = ["thumbnail.jpg", "thumbnail.jpeg", "thumbnail.png"]
          found = None
          for name in preferred:
              if os.path.exists(name):
                  found = name
                  break

          if not found:
              candidates = []
              for f in os.listdir("."):
                  lower = f.lower()
                  if lower in ("thumbnail.jpg", "thumbnail.jpeg", "thumbnail.png"):
                      continue
                  if lower.endswith((".jpg",".jpeg",".png")) and not lower.startswith("output"):
                      candidates.append(f)
              if candidates:
                  candidates.sort()
                  found = candidates[0]

          if found:
              src_abs = os.path.abspath(found)
              dest_abs = os.path.abspath(dest)
              if src_abs != dest_abs:
                  shutil.copy(found, dest)
                  print("Using repo thumbnail:", found)
              else:
                  print("Repo already has thumbnail.jpg, using it as-is.")
          else:
              print("No thumbnail image found in repo. Creating dark placeholder thumbnail.")
              cmd = (
                  "ffmpeg -y -f lavfi -i color=c=black:s=1280x720:d=1 "
                  "-vframes 1 -q:v 2 thumbnail.jpg"
              )
              subprocess.run(cmd, shell=True, check=True)
          PY

      # ----------------------------------------------------------
      # SAVE USED TOPIC (TITLE) â€“ APPENDED BY SCRIPT_GENERATE
      # ----------------------------------------------------------
      - name: Commit used topics
        run: |
          set -euo pipefail
          if [ -f used_topics.txt ]; then
            tail -n 500 used_topics.txt > used_topics.trim && mv used_topics.trim used_topics.txt
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add used_topics.txt || true
            git commit -m "Update used topics" || echo "No changes to commit"
            git push || echo "Git push failed (probably no permissions)."
          else
            echo "No used_topics.txt to commit."
          fi

      # ----------------------------------------------------------
      # UPLOAD ARTIFACTS
      # ----------------------------------------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: youtube-short-${{ github.run_id }}
          path: |
            output.mp4
            script.txt
            script_meta.json
            tts-audio.wav
            thumbnail.jpg
            used_topics.txt

      # ----------------------------------------------------------
      # JOB SUMMARY
      # ----------------------------------------------------------
      - name: Job summary
        if: always()
        run: |
          set -euo pipefail
          if [ -f script_meta.json ]; then
            TITLE=$(python -c "import json;print(json.load(open('script_meta.json',encoding='utf-8'))['title'])")
          else
            TITLE="Unknown title"
          fi
          echo "Title: $TITLE" | tee -a "$GITHUB_STEP_SUMMARY"
          echo "Category: $CATEGORY" | tee -a "$GITHUB_STEP_SUMMARY"
