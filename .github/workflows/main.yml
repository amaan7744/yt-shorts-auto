name: Auto YouTube Short

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0,3,7,11,15,18,21 * * *"

concurrency:
  group: auto-youtube-short
  cancel-in-progress: true

jobs:
  make-video:
    runs-on: ubuntu-latest
    timeout-minutes: 35

    permissions:
      contents: write

    steps:
      # ----------------------------------------------------------
      # CHECKOUT
      # ----------------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------------------------------------
      # PYTHON + SYSTEM DEPS
      # ----------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install system & Python deps
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg jq libsndfile1
          pip install --upgrade pip
          pip install -r requirements.txt

      # ----------------------------------------------------------
      # PICK CATEGORY
      # ----------------------------------------------------------
      - name: Pick category
        run: |
          CATEGORY=$(shuf -e crime mystery hidden_history | head -n1)
          echo "CATEGORY=$CATEGORY" >> "$GITHUB_ENV"
          echo "Chosen category: $CATEGORY"

      # ----------------------------------------------------------
      # SCRIPT GENERATION (DEEPSEEK)
      # ----------------------------------------------------------
      - name: Generate script via DeepSeek (OpenRouter)
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          DEEPSEEK_MODEL: ${{ secrets.DEEPSEEK_MODEL }}
          CATEGORY: ${{ env.CATEGORY }}
        run: |
          set -euo pipefail
          echo "Running script_generate.py..."
          python script_generate.py
          echo "Script generated:"
          head -n 5 script.txt || true

      # ----------------------------------------------------------
      # TTS NARRATION (XTTS-v2 VOICE CLONE)
      # ----------------------------------------------------------
      - name: Generate narration (XTTS-v2 voice clone)
        env:
          COQUI_TOS_AGREED: "1"
        run: |
          set -euo pipefail
          python tts_generate.py --output tts.wav
          echo "XTTS narration saved as tts.wav"

      # ----------------------------------------------------------
      # AUDIO MIX (RAIN / WIND / AMBIENCE)
      # ----------------------------------------------------------
      - name: Mix ambience with narration
        run: |
          set -euo pipefail
          python audio_mix.py tts.wav final_audio.wav
          echo "Audio mix created → final_audio.wav"

      # ----------------------------------------------------------
      # IMAGE FETCH (WIKIPEDIA PD + PEXELS)
      # ----------------------------------------------------------
      - name: Fetch images
        env:
          PEXELS_KEY: ${{ secrets.PEXELS_KEY }}
        run: |
          set -euo pipefail
          python image_fetch.py
          echo "Images fetched."

      # ----------------------------------------------------------
      # VIDEO BUILD (IMAGES + AUDIO)
      # ----------------------------------------------------------
      - name: Build video
        run: |
          set -euo pipefail
          python video_build.py final_audio.wav
          echo "Raw video → video_raw.mp4"

      # ----------------------------------------------------------
      # SYNC VIDEO TO AUDIO (PREVENT FRAME FREEZE)
      # ----------------------------------------------------------
      - name: Sync duration to audio (fix freezing)
        run: |
          set -euo pipefail
          DURATION=$(ffprobe -v error -show_entries format=duration -of csv=p=0 final_audio.wav)
          echo "Audio duration: $DURATION sec"
          ffmpeg -y -i video_raw.mp4 -t "$DURATION" -c:v libx264 -preset veryfast -crf 22 -pix_fmt yuv420p output.mp4
          echo "Final output: output.mp4"

      # ----------------------------------------------------------
      # THUMBNAIL
      # ----------------------------------------------------------
      - name: Create thumbnail
        run: |
          set -euo pipefail
          if [ -f thumbnail.jpg ]; then
            cp thumbnail.jpg final_thumbnail.jpg
            echo "Using user thumbnail"
          else
            ffmpeg -y -i output.mp4 -ss 00:00:01 -vframes 1 final_thumbnail.jpg
            echo "Generated frame thumbnail"
          fi

      # ----------------------------------------------------------
      # SAVE USED TOPIC
      # ----------------------------------------------------------
      - name: Save used topic
        run: |
          set -euo pipefail
          if [ -f script_meta.json ]; then
            TITLE=$(jq -r '.title' script_meta.json)
            echo "$TITLE" >> used_topics.txt
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add used_topics.txt
            git commit -m "Used topic: $TITLE" || true
            git push || true
          else
            echo "script_meta.json missing – skipping used_topics update."
          fi

      # ----------------------------------------------------------
      # UPLOAD ARTIFACTS
      # ----------------------------------------------------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: youtube-short
          path: |
            output.mp4
            final_audio.wav
            script.txt
            script_meta.json
            final_thumbnail.jpg
